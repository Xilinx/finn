# FINN Instrumentation Wrapper Platform
A platform targeting Versal devices for capturing the performance of models built using the FINN compiler.

### **Requires Vivado/Vitis 2022.2 Tools**

## How to run

### Setting up build parameters
The various parameters used within the build (board name, clock frequency etc.) are defined in the top-level `Makefile` in the `instr_wrap_platform` folder. These can be changed according to the requirements of the build. \
\
```
###############################################
# Variables that may be changed to your needs #
###############################################

# ILA_EN = 0 (Disabled) or 1 (Enabled)
export ILA_EN                     := 0

# BOARD_NAME = vmk180, vck190
export BOARD_NAME                 := vmk180

# For remote hardware server, set the network protocol, hostname and port to connect to
export HW_SERVER_HOST             := <HW_SERVER_HOST>
export HW_SERVER_PORT             := 3121

# Set if design is single- or double-pumped (1 if double-pumped, 0 if single-pumped)
export DOUBLE_PUMPED              := 0

# Set frequencies of the clocks in the platform
export AP_CLK_MHZ                 := 200
export AP_CLK_2X_MHZ              := 400
```
\
\
**NOTE: It is assumed that the targeted device is set up remotely with a `hw_server` active for it. Therefore, please make sure to change the `HW_SERVER` parameters within the top-level `Makefile` so that the device can be connected to in order to run the instrumentation wrapper.**

### Building the FINN model
The FINN model should first be built, with the custom steps defined in `platform_build_steps.py` appended to the build flow. These steps will produce a `.xo` kernel object file for the FINN design and the instrumentation wrapper, which will be used by Vitis in order to build the instrumentation wrapper platform. These two files can be found the `<BUILD_OUTPUT_FOLDER>/xo` folder, as `finn_design.xo` and `instrumentation_wrapper.xo` respectively.

### Building the platform using `make` commands
Copy the the `.xo` files generated by the FINN compiler build into the `instr_wrap_platform/vitis/ip` directories (specifically, copy `finn_design.xo` to `instr_wrap_platform/vitis/ip/finn_design/src`, and `instrumentation_wrapper.xo` to `instr_wrap_platform/vitis/ip/instrumentation_wrapper/src`). Then, from the `instr_wrap_platform` directory, run `make all`. This will check to ensure that the correct version of the tools are sourced, then run the four `make` steps needed to build the platform for the instrumentation wrapper to run on:
* `make vivado_platform` : Builds the `.xsa` hardware design file for creating the software platform using Vivado
* `make vitis_platform`  : Builds the `.xpfm` software platform file for use in Vitis
* `make vitis_ip`        : Copies the `.xo` kernel files to the `xo_hw` folder for use in linking the Vitis IPs to the platform
* `make full_impl`       : Links the Vitis IPs with the platform, then builds the full Vivado project to generate a `.pdi` device image file

### (Alternative method) Building the platform with the FINN build flow
The instrumentation wrapper platform could also be built as part of the FINN build flow by additionally appending the two steps `test_step_export_xo` and `test_step_build_platform` to the FINN build configuration, both of which are also defined in `platform_build_steps.py`. These steps would simply copy the `.xo` files to their respective locations and then run the aforementioned `make` commands through the `subprocess` module. A simple example which builds the TFC-w1a1 model is given in `build.py`, with the additional steps added to the default build flow. The example can be run by calling the FINN Docker container to do a custom build (e.g. `$FINN_ROOT/run-docker.sh build_custom . build`). This method would allow the FINN model and the platform to be built in one go, rather than having to build them separately. However, this may make it more difficult to debug any problems in the model. \
\
The additional build steps, along with the files in the `instr_wrap_platform` folder, could potentially be used in any FINN build to build a platform for the instrumentation wrapper to run on.\
\
**Note: Depending on the complexity of the model, the platform may take a few minutes to a few hours to build.**

### Running the instrumentation wrapper
The instrumentation wrapper will output to the serial port that the targeted device is connected to, so a serial terminal should be opened for the device. This could be done through commands like `screen <DEVICE_SERIAL_PORT> <BAUD_RATE>`, or through programs like PuTTY. \
\l
Once the build has successfully completed, from the `instr_wrap_platform` folder, run `make run_instr_wrap`. This will program the device with the generated `.pdi` device image file and export the `.xsa` hardware platform file through Vivado, and then build the instrumentation wrapper platform and application through Vitis. The targeted device will be connected to via the `hw_server`, and then the instrumentation wrapper will be run on the device. The output will then be printed on the serial terminal. \
\
If the ILA has been enabled by setting `ILA_EN` to 1 in the top-level `Makefile`, Vivado will then open and display the ILA waveform from running the instrumentation wrapper.
